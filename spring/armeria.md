# Armeria

> LINE에서 개발한 새로운 MVC 프레임워크!

Armeria는 제한된 개수의 스레드 풀을 위해서 이벤트 루프를 기반으로 비동기 메커니즘을 구현한 비동기 서버입니다. 

## 🌿 LINE에서 Spring 프로젝트를 Armeria로 마이그레이션 하는 이유?

**API 게이트웨이 역할**을 하는 `Channel Gateway` 컴포넌트는 LINE의 여러 패밀리 서비스와 서드파티 앱들이 LINE에서 리소스를 가져가고 싶을 때 반드시 거쳐야 하는 컴포넌트입니다. LINE에 존재하는 여러 리소스를 다양한 형태로 가공해서 클라이언트로 보내야 하는 역할을 맡고 있으며, 그에 따라 굉장히 많은 업스트림 서비스가 Channel Gateway 서버에 연결되어 있습니다. 

### 기존의 아키텍처

기존에는 전형적인 Spring MVC 어플리케이션으로 구성되어 있었습니다. 서버에서의 네트워크는 모두 Tomcat으로 처리하고, 업스트림과의 통신은 Apache HTTPClient를 사용해 동기 방식으로 처리 했습니다. 이러한 구조에서는 하나의 업스트림 서버에 장애가 발생해 응답 지연 시간이 길어지는 경우, 그로부터 파생된 장애가 전체 서버 시스템을 마비시키는 문제가 있었습니다. 

이러한 문제를 해결하기 위해 서버를 여러 그룹으로 나눠 일부 서버는 특정 API만 서빙하는 방식으로 **문제를 일부 지역으로 격리**하려고 했었지만, 리소스 관리 측면에서 그렇게 좋은 방법은 아니었습니다. 

### Armeria로 마이그레이션

단계적으로 마이그레이션을 진행합니다..

<img width="537" alt="image" src="https://user-images.githubusercontent.com/45311765/203541247-94e84c8f-9794-4ddf-8fc9-c56794d5a63c.png">

위와 같이 업스트림 서버에서 무언가를 다운로드하고 메모리에 적재한 뒤 다시 응답으로 만들어 클라이언트로 보내는 서비스가 있을 때, 이에 대한 요청이 한 번에 폭발적으로 들어오는 상황을 가정해볼까요? 

서블릿은 한 요청당 하나의 전용 스레드를 할당해야 하기 때문에 스레드 풀 고갈 문제가 발생할 수 있습니다. 

Ameria는 완벽한 비동기 방식이며 리액티브하기 때문에 블로킹 서버에서 발생했던 문제들이 발생하지 않습니다. 비동기 프레임워크이기 때문에 더 이상 요청마다 전용 스레드가 하나씩 필요하지 않습니다. 만약 어떤 요청을 처리하다가 I/O가 발생하면, I/O가 완료될 때까지 해당 스레드가 대기하는 게 아니라 다른 요청을 처리할 수 있습니다. 이를 통해 적은 수의 스레드로도 효율을 극대화할 수 있고 컨텍스트 스위칭에 필요한 비용도 아낄 수 있습니다.



## 참고 자료

- [Armeria를 소개합니다 by LINE 이희승](https://engineering.linecorp.com/ko/blog/introduce-armeria/)
- [LINE 개발자들이 Spring 대신 Armeria를 사용하는 이유 by LINE 임경수, 김기환](https://engineering.linecorp.com/ko/blog/hello-armeria-bye-spring/)
