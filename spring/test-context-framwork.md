# Spring의 TestContextFramework

스프링은 테스트에 사용되는 어플리케이션 컨텍스트를 생성하고 관리하고 테스트에 적용해주는 기능을 가진 TestContextFramework를 제공합니다. 이는 IoC/DI를 지원하는 ApplicationContext를 테스트에서 효과적으로 사용하게 해줍니다. 

테스트 클래스는 테스트 컨텍스트로부터 어플리케이션 컨텍스트와 그에 담긴 빈을 제공받아 테스트 코드에서 사용합니다. 빈을 제공받을 때 스프링 답게 DI를 사용합니다. (@Autowired, @Inject 등)

## Context Caching
스프링은 테스트가 사용하는 컨텍스트를 캐싱해서 여러 테스트에서 하나의 컨텍스트를 공유할 수 있는 방법을 제공합니다. 동일한 컨텍스트 구성을 갖는 테스트끼리는 같은 컨텍스트를 공유할 수 있습니다. 이렇게 어플리케이션 컨텍스트를 만드는 횟수를 줄이면 테스트 속도를 빠르게 할 수 있습니다. 이때 동일한 켄텍스트 구성을 갖기 위해서는 테스트 클래스들이 동일한 설정파일을 가지고 있어야합니다. 

## Test와 Transaction.. 그리고 ORM
테스트 메서드에 @Transactional이 걸려있는 경우 스프링은 테스트가 끝나면 자동으로 롤백을 시킵니다. 이때 Hibernate와 같은 ORM을 사용할 경우 롤백된 트랜잭션의 작업을 DB에 반영할 필요가 없기 때문에 메모리 캐시의 엔티티 오브젝트를 제거하고 작업을 끝내버립니다. 결국 한 번도 SQL이 만들어져 DB에 전달되지 않고 테스트가 종료되기 때문에, DAO에 대한 제대로된 테스트가 진행됐다고 볼 수 없습니다. 이는 테스트 코드 내부에서 강제로 flush() 메서드를 호출하는 방법으로 해결할 수 있습니다. 만약 반복적인 SELECT에 대한 테스트가 필요한 경우에는 clear() 메서드를 호출해 내부 캐시를 강제로 비워줘야합니다. 이는 DAO에 대한 단위 테스트 뿐만 아니라 Service 테스트에서도 마찬가지입니다. 따라서 ORM을 사용하는 경우 테스트에서 의도적으로라도 한 번은 flush()를 호출해주는 것이 좋습니다.

> 그 동안 테스트를 작성하면서 JPA를 사용하기 때문에 쿼리를 확인하기위해 flush()를 호출해야하는 상황이 불편하다고 느껴졌는데.. ORM을 사용하는 이상 어쩔 수 없는 부분임을 알고 마음이 편해졌다:)

## 참고 자료
- 토비의 스프링 3.1 Vol.2
